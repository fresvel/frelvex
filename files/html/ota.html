<!DOCTYPE html>
<html>
  <head>
    <title>Iniciar Sesi√≥n</title>
    <link rel="stylesheet" href="bulma.css">
  </head>
  <body>
    <section class="hero is-fullheight is-dark">
      <div class="hero-body">
        
          
        
        <div class="container">
          
          <div class="columns is-centered">
            <div class="column is-4-tablet is-3-desktop is-2-widescreen">
              <br>
              <img src="logo.svg" width="150" height="255">
            </div>
            <div class="column is-5-tablet is-4-desktop is-3-widescreen"> 
              <form class="box" enctype="multipart/form-data" method="post" action="/ota_post">
                <div class="file has-name is-fullwidth">
                    <label class="file-label">
                      <input class="file-input" type="file" name="resume" id="archivoInput" onchange="actualizarNombreArchivo()">
                      <span class="file-cta">
                        <span class="file-icon">
                          <i class="fas fa-upload"></i>
                        </span>
                        <span class="file-label">
                          Choose a file
                        </span>
                      </span>
                      <span class="file-name" id="nombreArchivo">
                        file.bin
                      </span>
                    </label>
                </div>
                <div class="field">
                  <label class="label"><br></label>
                  <div class="control has-icons-left">
                    <progress class="progress is-success" value="0" max="100" id="prbar">0%</progress>
                    
                      <div class="notification is-light" id="resultado" hidden="true">
                        Filed Loaded
                      </div>
                      <span></span>
                    
                  </div>
                </div>
                <div class="field">
                  <button class="button is-primary is-fullwidth" type="button" onclick="sendFile()">
                    Upload
                  </button>
                </div>
              </form>
            </div>
            <div class="column is-4-tablet is-3-desktop is-2-widescreen"></div>
          </div>
        </div>
      </div>
    </section>
  </body>
  <script src="wsclient.js"></script>
  <script>

    let state=1;  
    function actualizarNombreArchivo() {
        var input = document.getElementById('archivoInput');
        var nombreArchivoSpan = document.getElementById('nombreArchivo');
        if (input.files.length > 0) {
            nombreArchivoSpan.textContent = input.files[0].name;
        } else {
            nombreArchivoSpan.textContent = 'Choose a file';
        }
    }

    function sendFile(){
      let input=document.getElementById("archivoInput");
      let file=input.files[0];
      let bar=document.getElementById("prbar")

      
      if (file){
        const chunk_size = 1024;
        let offset=0;
        websocket.send('a');

        function sendChunk(){
          if(state==1){
            const chunk=file.slice(offset,offset + chunk_size)
            websocket.send(chunk)
            offset += chunk_size
            if (offset < file.size){
              setTimeout(sendChunk,3)
              console.log("sending file chunk")
            }else{
              console.log("File send finished")
              websocket.send('b');
            }


            let prog=Math.round(offset/file.size*100);
            prog = Math.min(prog, 100);
            bar.value=prog;
            bar.innerHTML=`${prog}%`
            state=0;
          }else if(state==2){
            console.log("Error en la carga del fichero")
          }else{
            console.log("Waiting for response...")
            setTimeout(sendChunk,4)
          }
        }
        sendChunk();
      }else{
        alert("First select a file!");
      }
    }

    function ws_send_pkt(value){
      console.log("Sending packet...");
      websocket.send(value);
    }

    function onMessage(event) {
      res_ota=document.getElementById('resultado')
      if (event.data=='77')
        state=1;
      else if (event.data=='101'){
        state=2;
        res_ota.innerText = "Upload filed!";
        res_ota.classList.remove('is-success');
        res_ota.classList.add('is-danger');
        res_ota.removeAttribute('hidden');
      } 
      else if (event.data=='100'){
        res_ota.innerText = "File Loaded!";
        res_ota.classList.remove('is-danger');
        res_ota.classList.add('is-success');
        res_ota.removeAttribute('hidden');
      }
        
        console.log(`${event.data}\n`);
    }

</script>

</html>